var fileGrid;var selectRowData;function gotoFileView(a){selectRowData=a;centerDivHide();$("#viewTable").hide();$("#fileDiv").show();$("#consultaTion").show();fileView(selectRowData.uniqueCode);loadConsultaTionView(null)}function gotoFileViewInfo(a){selectRowData=a;if(a.sourceType=="2"){$.ajax({type:"POST",url:rootPath+"/consultationMedical/ehr/loadTree.json",data:{idCard:a.idCard},dataType:"json",success:function(c){if(c!=null){loadPatientsTree(c)}}})}else{checkConsultationStatus(a.uniqueCode,a.status)}}function checkConsultationStatus(c,a){$.ajax({type:"POST",url:rootPath+"/consultation/checkConsultationStatus.json",data:{uniqueCode:c,status:a},success:function(d){if(d==true){$("#viewTable").hide();centerDivHide();$("#imgFileDiv").hide();$("#fileDiv").show();$("#consultaTion").show();fileView(selectRowData.uniqueCode);loadConsultaTionView(null);if(selectRowData.status=="04"){loadCompletedConsultation(selectRowData.ehrCode)}}else{alert("该会诊记录状态已更新。请选择其他记录！")}}})}function centerDivHide(){var c=$("div[name=centerDiv]").hide();for(var a=0;a<c.length;a++){$(c[a]).hide()}}function fileView(a){$.ajax({type:"POST",url:rootPath+"/consultation/apply/fileList.json",data:{uniqueCode:a},dataType:"json",success:function(c){if(c!=null){loadTree(c)}}})}function getOfficeName(a){$.ajax({type:"POST",url:rootPath+"/common/getOffice.json",data:{code:a},success:function(c){if(c!=null){$("#tab_officeCode").html(c.name)}}})}function loadPatientsTree(a){centerDivHide();$("#viewTable").hide();$("#fileDiv").show();fileGrid=$("#fileGrid").treegrid({idField:"code",treeField:"name",width:"100%",fit:true,fitColumns:true,border:false,onDblClickRow:function(c){if(c.url!=null&&c.url!=""){loadPage(c)}},columns:[[{field:"code",title:"编号",hidden:true},{field:"name",title:"文件名称",width:150}]]});$("#fileGrid").treegrid("loadData",a.rows);closeAll()}function loadTree(a){fileGrid=$("#fileGrid").treegrid({idField:"code",treeField:"fileName",width:"100%",fit:true,fitColumns:true,border:false,onDblClickRow:function(c){dataClick(c)},columns:[[{field:"code",title:"编号",hidden:true},{field:"fileName",title:"文件名称",width:150},{field:"status",title:"文件状态",width:80,formatter:function(c){if(c=="0"){return"原始未转化格式"}else{if(c=="1"){return"文件转换中"}else{if(c=="2"){return"文件转换完成"}else{if(c=="3"){return"超时"}else{if(c=="4"){return"文件转换失败"}else{return""}}}}}}}]]});$("#fileGrid").treegrid("loadData",getTreeList(a));closeAll()}function closeAll(){var a=$("#fileGrid");var c=a.treegrid("getSelected");if(c){a.treegrid("collapseAll",c.code)}else{a.treegrid("collapseAll")}}function openAll(){var a=$("#fileGrid");var c=a.treegrid("getSelected");if(c){a.treegrid("expandAll",c.code)}else{a.treegrid("expandAll")}}function getTreeList(f){var m={rows:[]};var a={code:"01",fileName:"病例文档",path:"",status:"",parentCode:"",isTop:"0",index:"1",isChild:"0",children:[]};var l={code:"02",fileName:"心电报告",path:"",status:"",parentCode:"",isTop:"0",index:"2",isChild:"0",children:[]};var j={code:"03",fileName:"B超",path:"",status:"",parentCode:"",isTop:"0",index:"3",isChild:"0",children:[]};var h={code:"04",fileName:"超声",path:"",status:"",parentCode:"",isTop:"0",index:"4",isChild:"0",children:[]};var g={code:"05",fileName:"CT",path:"",status:"",parentCode:"",isTop:"0",index:"5",isChild:"0",children:[]};var d={code:"06",fileName:"DR",path:"",status:"",parentCode:"",isTop:"0",index:"6",isChild:"0",children:[]};var e={code:"07",fileName:"磁共振",path:"",status:"",parentCode:"",isTop:"0",index:"7",isChild:"0",children:[]};var i={code:"consultaTion",fileName:"基础信息",path:"",status:"",parentCode:"",isTop:"0",index:"0",isChild:"0",children:[],consultaTionCode:selectRowData.uniqueCode,type:"consultaTion"};var k=getChild(f,a.code);if(k!=null&&k.length>0){a.children=k}k=getChild(f,l.code);if(k!=null&&k.length>0){l.children=k}k=getChild(f,j.code);if(k!=null&&k.length>0){j.children=k}k=getChild(f,h.code);if(k!=null&&k.length>0){h.children=k}k=getChild(f,g.code);if(k!=null&&k.length>0){g.children=k}k=getChild(f,d.code);if(k!=null&&k.length>0){d.children=k}k=getChild(f,e.code);if(k!=null&&k.length>0){e.children=k}m.rows.push(i);m.rows.push(a);m.rows.push(l);m.rows.push(j);m.rows.push(h);m.rows.push(g);m.rows.push(d);m.rows.push(e);return m}function getChild(d,c){var a={rows:[]};if(d!=null){for(var e=0;e<d.length;e++){var f=d[e];if(c==f.materialType){f.code=c+e;f.parentCode=c;f.isTop=0;f.index=e;f.children=[];a.rows.push(f)}}}return a.rows}var isLoadpage=false;function loadPage(a){if(a.bussniseCode=="03"||a.bussniseCode=="04"||a.bussniseCode=="05"||a.bussniseCode=="06"||a.bussniseCode=="07"){if(!isLoadpage){$.ajax({type:"GET",url:rootPath+"/consultationMedical/ehr/mainCheckUSView.html?serialno=545",data:{},dataType:"html",success:function(c){$("#blpage").html(c);$.ajax({type:"GET",url:rootPath+a.url,data:{},dataType:"html",success:function(d){$("#div1").html(d);$("#blpage").show()}})}})}else{b=false;$.ajax({type:"GET",url:rootPath+a.url,data:{},dataType:"html",success:function(c){$("#div1").html(c)}})}return}$.ajax({type:"GET",url:rootPath+a.url,data:{},dataType:"html",success:function(c){$("#blpage").html(c);$("#blpage").show()}})}function dataClick(a){centerDivHide();if("consultaTion"==a.code){$("#consultaTion").show();loadConsultaTion(null)}else{if("01"==a.materialType){showDocView(a.swfPath);$("#docFileDiv").show()}else{if("02"==a.materialType){if(a.suffix=="pdf"){showDocView(a.swfPath);$("#docFileDiv").show()}else{if(c(a.suffix)){$("#centerImgFile").attr("src",rootPath+"/swf/ftp/"+a.path);$("#imgFileDiv").show()}}}else{if("03"==a.materialType||"04"==a.materialType||"05"==a.materialType||"06"==a.materialType||"07"==a.materialType){loadDcm(a);$("#dcmFileDiv").show()}}}}function c(d){if(d=="jpg"||d=="JPG"){return true}else{if(d=="png"||d=="PNG"){return true}else{if(d=="gif"||d=="GIF"){return true}else{if(d=="bmp"||d=="BMP"){return true}else{if(d=="jpeg"||d=="JPEG"){return true}}}}}return false}}function showDocView(c){var a=new FlexPaperViewer(rootPath+"/swf/FlexPaperViewer","docView",{config:{SwfFile:escape(rootPath+"/swf/ftp/"+c),Scale:1.5,ZoomTransition:"easeOut",ZoomTime:0.5,ZoomInterval:0.2,FitPageOnLoad:false,FitWidthOnLoad:false,FullScreenAsMaxWindow:false,ProgressiveLoading:false,MinZoomSize:0.2,MaxZoomSize:5,SearchMatchAll:false,InitViewMode:"Portrait",PrintPaperAsBitmap:false,ViewModeToolsVisible:true,ZoomToolsVisible:true,NavToolsVisible:true,CursorToolsVisible:true,SearchToolsVisible:true,localeChain:"en_US"}})}function loadConsultaTion(a){$("#idCard").val(obj2Str(selectRowData.idCard));$("#name").val(obj2Str(selectRowData.name));$("#officeCode").val(obj2Str(selectRowData.officeCode));$("#age").val(obj2Str(selectRowData.age));$("#nation").val(obj2Str(selectRowData.nation));$("#address").val(obj2Str(selectRowData.address));$("#occupation").val(obj2Str(selectRowData.occupation));$("#countyCode").val(obj2Str(selectRowData.countyCode));$("#ehrCode").val(obj2Str(selectRowData.ehrCode));$("#diseaseName").val(obj2Str(selectRowData.diseaseName));$("#diseaseCode").val(obj2Str(selectRowData.diseaseCode));$("#visitTabloid").val(obj2Str(selectRowData.visitTabloid));$("#purpose").val(obj2Str(selectRowData.purpose));$("#expectDateView").val(obj2Str(selectRowData.expectDateView));$("#expectTimeView").val(obj2Str(selectRowData.expectTimeView));$("#sexCode").combobox("setValues",obj2Str(selectRowData.sexCode));$("#emergencyMark").combobox("setValues",obj2Str(selectRowData.emergencyMark));$("#sourceCode").combobox("setValues",obj2Str(selectRowData.sourceCode));$("#visitType").combobox("setValues",obj2Str(selectRowData.visitType));$("#marriage").combobox("setValues",obj2Str(selectRowData.marriage));$("#centerCode").combobox("setValues",obj2Str(selectRowData.centerCode))}function loadConsultaTionView(a){$("#tab_idCard").html(obj2Str(selectRowData.idCard));$("#tab_name").html(obj2Str(selectRowData.name));getOfficeName(obj2Str(selectRowData.officeCode));$("#tab_age").html(obj2Str(selectRowData.age));$("#tab_nation").html(obj2Str(selectRowData.nation));$("#tab_address").html(obj2Str(selectRowData.address));$("#tab_occupation").html(obj2Str(selectRowData.occupation));$("#tab_countyCode").html(obj2Str(selectRowData.countyCode));$("#tab_ehrCode").html(obj2Str(selectRowData.ehrCode));$("#tab_diseaseName").html(obj2Str(selectRowData.diseaseName));$("#tab_diseaseCode").html(obj2Str(selectRowData.diseaseCode));$("#tab_visitTabloid").html(obj2Str(selectRowData.visitTabloid));$("#tab_purpose").html(obj2Str(selectRowData.purpose));$("#tab_expectDateView").html(selectRowData.expectDateView);$("#tab_expectTimeView").html(selectRowData.expectTimeView);$("#tab_returnReason").html(obj2Str(selectRowData.returnReason));$("#tab_sexCode").html(function(){if(obj2Str(selectRowData.sexCode)==1){return"男"}else{return"女"}});$("#tab_emergencyMark").html(function(){if(obj2Str(selectRowData.emergencyMark)==0){return"普诊"}else{return"急诊"}});$("#tab_sourceCode").html(function(){if(obj2Str(selectRowData.sourceCode)==1){return"个人申请"}else{return"医院申请"}});$("#tab_visitType").html(function(){if(obj2Str(selectRowData.visitType)==1){return"离线会诊"}else{return"视频会诊"}});$("#tab_marriage").html(function(){if(obj2Str(selectRowData.marriage)==1){return"未婚"}else{return"已婚"}});$("#tab_centerCode").html(obj2Str(selectRowData.centerCode))}function obj2Str(a){if(a==null||a==undefined){return""}else{return a}}function goBack(){$("#viewTable").show();centerDivHide();$("#context").val("");$("#remak").val("")}function saveDiagnosis(){if($("#context").val()==null||$("#context").val()==undefined||$("#context").val().trim()==""){alert("诊断结论不能为空!");return}parent.$.messager.confirm("询问","您是否要发送诊断报告？",function(a){if(a){$.ajax({type:"POST",url:rootPath+"/consultation/diagnosis.json",data:{consultationCode:selectRowData.uniqueCode,verdict:$("#context").val(),mavinCode:selectRowData.mavinCode},dataType:"json",success:function(c){if(c.success){alert("报告发送成功！")}else{alert("你没有诊断权限！")}goBack()}})}})}function consultationApply(a){parent.$.messager.confirm("询问","您是否确定申请会诊？",function(c){if(c){$.ajax({type:"POST",url:rootPath+"/consultation/apply/submitapply.json",data:{id:obj2Str(selectRowData.id),fromPage:a},dataType:"json",success:function(d){alert("申请提交成功");goBack();$("#dataGrid").datagrid("reload")}})}})}function consultationReturnCenter(){parent.$.messager.confirm("询问","您是否确定把当前会诊退回中心？",function(a){if(a){$.ajax({type:"POST",url:rootPath+"/consultation/apply/submitapply.json",data:{id:obj2Str(selectRowData.id)},dataType:"json",success:function(c){alert("会诊已发送会中心");goBack();$("#dataGrid").datagrid("reload")}})}})}function consultationAudit(){var c=$("#diagnosisOrganCode").val();var a=$("#mavinCode").val();if(c==null||c==undefined||c.trim()==""){alert("诊断机构不能为空!");return}if(a==null||a==undefined||a.trim()==""){alert("专家不能为空");return}parent.$.messager.confirm("询问","您是否确定会诊审核通过？",function(d){if(d){$.ajax({type:"POST",url:rootPath+"/consultation/audit/auditapprove.json",data:{diagnosisOrganCode:c,mavinCode:a,id:obj2Str(selectRowData.id)},dataType:"json",success:function(e){alert("审核通过！");goBack();$("#dataGrid").datagrid("reload")}})}})}function consultationReturn(){if($("#returnReason").val()==null||$("#returnReason").val()==undefined||$("#returnReason").val().trim()==""){alert("退回理由不能为空!");return}parent.$.messager.confirm("询问","您是否确定退回审核？",function(a){if(a){$.ajax({type:"POST",url:rootPath+"/consultation/audit/invalid.json",data:{returnReason:$("#returnReason").val(),id:obj2Str(selectRowData.id)},dataType:"json",success:function(c){alert("审核退回成功！");goBack();$("#dataGrid").datagrid("reload")}})}})}function consultReturn(){if($("#returnReason").val()==null||$("#returnReason").val()==undefined||$("#returnReason").val().trim()==""){alert("退回理由不能为空!");return}parent.$.messager.confirm("询问","您是否确定退回审核？",function(a){if(a){$.ajax({type:"POST",url:rootPath+"/consultation/consult/invalid.json",data:{returnReason:$("#returnReason").val(),id:obj2Str(selectRowData.id)},dataType:"json",success:function(c){alert("审核退回成功！");goBack();$("#dataGrid").datagrid("reload")}})}})}function loadCompletedConsultation(a){if(a==null&&a==undefined&&a==""){return}$.ajax({type:"POST",url:rootPath+"/consultation/completed/loadCompletedConsultation.json",data:{mainFlowCode:a},dataType:"json",success:function(c){$("#tab_verdict").html(c.verdict);$("#tab_visitDate").html(new Date(c.visitDate).Format("yyyy-MM-dd").toLocaleString())}})};